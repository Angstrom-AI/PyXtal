
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>crystallography.molecular_crystal &#8212; crystallography 0.1dev documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">crystallography 0.1dev documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for crystallography.molecular_crystal</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for generation of random molecular crystals which meet symmetry</span>
<span class="sd">constraints. A pymatgen- or spglib-type structure object is created, which can</span>
<span class="sd">be saved to a .cif file. Options (preceded by two dashes) are provided for</span>
<span class="sd">command-line usage of the module:  </span>

<span class="sd">    spacegroup (-s): the international spacegroup number to be generated.</span>
<span class="sd">        Defaults to 36  </span>

<span class="sd">    molecule (-e): the chemical formula of the molecule to use. For multiple</span>
<span class="sd">        molecule types, separate entries with commas. Ex: &quot;C60&quot;, &quot;H2O, CH4,</span>
<span class="sd">        NH3&quot;. Defaults to H2O  </span>

<span class="sd">    numMols (-n): the number of molecules in the PRIMITIVE unit cell (For</span>
<span class="sd">        P-type spacegroups, this is the same as the number of molecules in the</span>
<span class="sd">        conventional unit cell. For A, B, C, and I-centered spacegroups, this</span>
<span class="sd">        is half the number of the conventional cell. For F-centered unit cells,</span>
<span class="sd">        this is one fourth the number of the conventional cell.). For multiple</span>
<span class="sd">        molecule types, separate entries with commas. Ex: &quot;8&quot;, &quot;1, 4, 12&quot;.</span>
<span class="sd">        Defaults to 4  </span>

<span class="sd">    factor (-f): the relative volume factor used to generate the unit cell.</span>
<span class="sd">        Larger values result in larger cells, with molecules spaced further</span>
<span class="sd">        apart. If generation fails after max attempts, consider increasing this</span>
<span class="sd">        value. Defaults to 3.0  </span>

<span class="sd">    verbosity (-v): the amount of information which should be printed for each</span>
<span class="sd">        generated structure. For 0, only prints the requested and generated</span>
<span class="sd">        spacegroups. For 1, also prints the Wyckoff positions and time elapsed.</span>
<span class="sd">        For 2, also prints the contents of the generated pymatgen structure.</span>
<span class="sd">        Defaults to 0  </span>

<span class="sd">    attempts (-a): the number of structures to generate. Note: if any of the</span>
<span class="sd">        attempts fail, the number of generated structures will be less than this</span>
<span class="sd">        value. Structures will be output to separate cif files. Defaults to 1  </span>

<span class="sd">    outdir (-o): the file directory where cif files will be output to. Defaults</span>
<span class="sd">        to &quot;.&quot;  </span>

<span class="sd">    checkatoms (-c): whether or not to check inter-atomic distances at each step</span>
<span class="sd">        of generation. When True, produces more accurate results, but requires</span>
<span class="sd">        more computation time for larger molecules. When False, produces less</span>
<span class="sd">        accurate results and may require a larger volume factor, but does not</span>
<span class="sd">        require more computation time for large molecules. Generally, the flag</span>
<span class="sd">        should only be set to False for large, approximately spherical molecules</span>
<span class="sd">        like C60. Defaults to True  </span>

<span class="sd">    allowinversion (-i): whether or not to allow inversion of chiral molecules</span>
<span class="sd">        for spacegroups which contain inversional and/or rotoinversional</span>
<span class="sd">        symmetry. This should only be True if the chemical and biological</span>
<span class="sd">        properties of the mirror molecule are known and suitable for the desired</span>
<span class="sd">        application. Defaults to False  </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">crystallography.crystal</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">crystallography.molecule</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">crystallography.operations</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="n">max1</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1">#Attempts for generating lattices</span>
<span class="n">max2</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1">#Attempts for a given lattice</span>
<span class="n">max3</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1">#Attempts for a given Wyckoff position</span>

<div class="viewcode-block" id="estimate_volume_molecular"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.estimate_volume_molecular">[docs]</a><span class="k">def</span> <span class="nf">estimate_volume_molecular</span><span class="p">(</span><span class="n">numMols</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the volume needed for a molecular crystal conventional unit cell.</span>

<span class="sd">    Args:</span>
<span class="sd">        numMols: A list with the number of each type of molecule</span>
<span class="sd">        boxes: A list of bounding boxes for each molecule. Obtained from get_box</span>
<span class="sd">        factor: a factor to multiply the final result by. Used to increase space</span>
<span class="sd">        between molecules</span>

<span class="sd">    Returns:</span>
<span class="sd">        the estimated volume (in cubic Angstroms) needed for the unit cell</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">numMol</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">numMols</span><span class="p">,</span> <span class="n">boxes</span><span class="p">):</span>
        <span class="n">volume</span> <span class="o">+=</span> <span class="n">numMol</span><span class="o">*</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">box</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">factor</span><span class="o">*</span><span class="n">volume</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_sg_orientations"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.get_sg_orientations">[docs]</a><span class="k">def</span> <span class="nf">get_sg_orientations</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">allow_inversion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PB</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the valid orientations for each Molecule and Wyckoff position.</span>
<span class="sd">    Returns a list with 3 indices:</span>

<span class="sd">        index 1: the Wyckoff position&#39;s 1st index (based on multiplicity)  </span>

<span class="sd">        index 2: the WP&#39;s 2nd index (within the group of equal multiplicity)  </span>

<span class="sd">        index 3: the index of the valid orientation for the molecule/WP pair</span>

<span class="sd">    For example, self.valid_orientations[i][j] would be a list of valid</span>
<span class="sd">    orientations for self.molecules[i], in the Wyckoff position</span>
<span class="sd">    self.wyckoffs[i][j]</span>

<span class="sd">    Args:</span>
<span class="sd">        mol: a pymatgen Molecule object.</span>
<span class="sd">        sg: the international spacegroup number</span>
<span class="sd">        allow_inversion: whether or not to allow inversion operations for chiral</span>
<span class="sd">            molecules</span>

<span class="sd">    Returns:</span>
<span class="sd">        a list of operations orientation objects for each Wyckoff position. 1st</span>
<span class="sd">            and 2nd indices correspond to the Wyckoff position</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_orientations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">wyckoffs</span> <span class="o">=</span> <span class="n">get_wyckoffs</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">organized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">PB</span><span class="o">=</span><span class="n">PB</span><span class="p">)</span>
    <span class="n">wp_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wyckoffs</span><span class="p">):</span>
        <span class="n">valid_orientations</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">wp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">wp_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="n">orientation_in_wyckoff_position</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">wp_index</span><span class="p">,</span> <span class="n">already_oriented</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_inversion</span><span class="o">=</span><span class="n">allow_inversion</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">allowed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">valid_orientations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">valid_orientations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
    <span class="k">return</span> <span class="n">valid_orientations</span></div>

<div class="viewcode-block" id="get_box"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.get_box">[docs]</a><span class="k">def</span> <span class="nf">get_box</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a molecule, find a minimum orthorhombic box containing it.</span>
<span class="sd">    Size is calculated using min and max x, y, and z values.</span>
<span class="sd">    For best results, call oriented_molecule first.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        mol: a pymatgen Molecule object</span>
<span class="sd">        padding: the extra space to be added in each direction. Double this</span>
<span class="sd">            amount will be added to each of the x, y, and z directions</span>

<span class="sd">    Returns:</span>
<span class="sd">        a list [x1,x2,y1,y2,z1,z2] where x1 is the relative displacement in</span>
<span class="sd">        the negative x direction, x2 is the displacement in the positive x</span>
<span class="sd">        direction, and so on</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">minz</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">maxz</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">coords</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">minx</span><span class="p">:</span> <span class="n">minx</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">minx</span><span class="p">:</span> <span class="n">minx</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">minx</span><span class="p">:</span> <span class="n">minx</span> <span class="o">=</span> <span class="n">z</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">maxx</span><span class="p">:</span> <span class="n">maxx</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">maxx</span><span class="p">:</span> <span class="n">maxx</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="n">maxx</span><span class="p">:</span> <span class="n">maxx</span> <span class="o">=</span> <span class="n">z</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">minx</span><span class="o">-</span><span class="n">padding</span><span class="p">,</span><span class="n">maxx</span><span class="o">+</span><span class="n">padding</span><span class="p">,</span><span class="n">miny</span><span class="o">-</span><span class="n">padding</span><span class="p">,</span><span class="n">maxy</span><span class="o">+</span><span class="n">padding</span><span class="p">,</span><span class="n">minz</span><span class="o">-</span><span class="n">padding</span><span class="p">,</span><span class="n">maxz</span><span class="o">+</span><span class="n">padding</span><span class="p">]</span></div>

<div class="viewcode-block" id="check_distance_molecular"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.check_distance_molecular">[docs]</a><span class="k">def</span> <span class="nf">check_distance_molecular</span><span class="p">(</span><span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="p">,</span> <span class="n">indices1</span><span class="p">,</span> <span class="n">index2</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the distances between two set of molecules. The first set is generally</span>
<span class="sd">    larger than the second. Distances between coordinates within the first set</span>
<span class="sd">    are not checked, and distances between coordinates within the second set are</span>
<span class="sd">    not checked. Only distances between points from different sets are checked.</span>

<span class="sd">    Args:</span>
<span class="sd">        coord1: multiple lists of fractional coordinates e.g. [[[.1,.6,.4],</span>
<span class="sd">            [.3,.8,.2]],[[.4,.4,.4],[.3,.3,.3]]]</span>
<span class="sd">        coord2: a list of new fractional coordinates e.g. [[.7,.8,.9],</span>
<span class="sd">            [.4,.5,.6]]</span>
<span class="sd">        indices1: the corresponding molecular indices of coord1, e.g. [1, 3].</span>
<span class="sd">            Indices correspond to which value in radii to use</span>
<span class="sd">        index2: the molecular index for coord2. Corresponds to which value in</span>
<span class="sd">            radii to use</span>
<span class="sd">        lattice: matrix describing the unit cell vectors</span>
<span class="sd">        radii: a list of radii used to judge whether or not two molecules</span>
<span class="sd">            overlap</span>
<span class="sd">        d_factor: the tolerance is multiplied by this amount. Larger values</span>
<span class="sd">            mean molecules must be farther apart</span>
<span class="sd">        PBC: value to be passed to create_matrix for periodic boundary conditions</span>

<span class="sd">    Returns:</span>
<span class="sd">        a bool for whether or not the atoms are sufficiently far enough apart</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#add PBC</span>
    <span class="n">coord2s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">create_matrix</span><span class="p">(</span><span class="n">PBC</span><span class="o">=</span><span class="n">PBC</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coord2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matrix</span><span class="p">:</span>
            <span class="n">coord2s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="o">+</span><span class="n">m</span><span class="p">)</span>
    <span class="n">coord2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coord2s</span><span class="p">)</span>

    <span class="n">coord2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coord2</span><span class="p">,</span> <span class="n">lattice</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">index1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coord1</span><span class="p">,</span> <span class="n">indices1</span><span class="p">):</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">lattice</span><span class="p">)</span>
            <span class="n">d_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cdist</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">coord2</span><span class="p">))</span>

            <span class="n">tol</span> <span class="o">=</span> <span class="p">(</span><span class="n">radii</span><span class="p">[</span><span class="n">index1</span><span class="p">]</span><span class="o">+</span><span class="n">radii</span><span class="p">[</span><span class="n">index2</span><span class="p">])</span>

            <span class="c1">#print(d_min, tol)</span>
            <span class="k">if</span> <span class="n">d_min</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="check_wyckoff_position_molecular"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.check_wyckoff_position_molecular">[docs]</a><span class="k">def</span> <span class="nf">check_wyckoff_position_molecular</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">wyckoffs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exact_translation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PB</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of points, returns the index of the Wyckoff position within</span>
<span class="sd">    the spacegroup.</span>

<span class="sd">    Args:</span>
<span class="sd">        points: a list of 3d fractional coordinates or SymmOps to check</span>
<span class="sd">        sg: the international space group number to check</span>
<span class="sd">        wyckoffs: a list of (unsorted) Wyckoff positions obtained from</span>
<span class="sd">            get_wyckoffs.</span>
<span class="sd">        exact_translation: whether we require two SymmOps to have exactly equal</span>
<span class="sd">            translational components. If false, translations related by +-1 are</span>
<span class="sd">            considered equal</span>

<span class="sd">    Returns:</span>
<span class="sd">        a single index corresponding to the detected Wyckoff position. If no</span>
<span class="sd">        valid Wyckoff position is found, returns False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">points</span><span class="o">*</span><span class="mf">1e+10</span><span class="p">))</span><span class="o">/</span><span class="mf">1e+10</span>

    <span class="k">if</span> <span class="n">wyckoffs</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wyckoffs</span> <span class="o">=</span> <span class="n">get_wyckoffs</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">PB</span><span class="o">=</span><span class="n">PB</span><span class="p">)</span>
        <span class="n">gen_pos</span> <span class="o">=</span> <span class="n">wyckoffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gen_pos</span> <span class="o">=</span> <span class="n">wyckoffs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">exact_translation</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">new_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filtered_coords</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="n">PBC</span><span class="p">))</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">new_points</span>
    <span class="n">w_symm_all</span> <span class="o">=</span> <span class="n">get_wyckoff_symmetry</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span>
    <span class="n">p_symm</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#If exact_translation is false, store WP&#39;s which might be a match</span>
    <span class="n">possible</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
        <span class="n">p_symm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site_symm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">gen_pos</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="n">PBC</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">wp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wyckoffs</span><span class="p">):</span>
        <span class="n">w_symm</span> <span class="o">=</span> <span class="n">w_symm_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_symm</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">w_symm</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">w_symm</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_symm</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exact_translation</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">w</span><span class="p">:</span>
                            <span class="n">temp</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">exact_translation</span><span class="p">:</span>
                        <span class="n">temp2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">op_p</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">op_w</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
                                <span class="c1">#Check that SymmOp&#39;s are equal up to some integer translation</span>
                                <span class="k">if</span> <span class="n">are_equal</span><span class="p">(</span><span class="n">op_w</span><span class="p">,</span> <span class="n">op_p</span><span class="p">,</span> <span class="n">allow_pbc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                                    <span class="n">temp2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">op_w</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">temp2</span> <span class="o">==</span> <span class="p">[]:</span>
                            <span class="n">temp</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">temp</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="c1">#If we find a match with exact translations</span>
                <span class="k">if</span> <span class="n">exact_translation</span><span class="p">:</span>
                    <span class="c1">#Check orientations</span>
                    <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">jk_from_i</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">orientations</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">orientations</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="k">return</span> <span class="n">i</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">exact_translation</span><span class="p">:</span>
                    <span class="n">possible</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c1">#If no matching WP&#39;s are found</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1">#If any matching WP&#39; are found</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">possible</span><span class="p">:</span>
            <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">jk_from_i</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">orientations</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">orientations</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">generators</span> <span class="o">=</span> <span class="n">get_wyckoff_generators</span><span class="p">(</span><span class="n">sg</span><span class="p">)[</span><span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">find_generating_point</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">generators</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="n">PBC</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Could not generate coordinates for detected Wyckoff position.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Suspected Wyckoff position: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">letter_from_index</span><span class="p">(</span><span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sg</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Coordinates:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#Check that points are correctly generated</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
                <span class="n">generators</span> <span class="o">=</span> <span class="n">get_wyckoff_generators</span><span class="p">(</span><span class="n">sg</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">find_generating_point</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">generators</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="n">PBC</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">i</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Could not generate coordinates for detected Wyckoff position.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Suspected Wyckoff positions:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">letter_from_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sg</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Coordinates:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unexpected error in check_wyckoff_position_molecular.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="merge_coordinate_molecular"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.merge_coordinate_molecular">[docs]</a><span class="k">def</span> <span class="nf">merge_coordinate_molecular</span><span class="p">(</span><span class="n">coor</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">wyckoff</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PB</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pairs</span><span class="p">,</span> <span class="n">graph</span> <span class="o">=</span> <span class="n">find_short_dist</span><span class="p">(</span><span class="n">coor</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="n">PBC</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">valid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coor</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">wyckoff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">groups</span> <span class="o">=</span> <span class="n">connected_components</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_center</span><span class="p">(</span><span class="n">coor</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="n">PBC</span><span class="p">))</span>
                <span class="n">merged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">check_wyckoff_position_molecular</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">exact_translation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="n">PBC</span><span class="p">,</span> <span class="n">PB</span><span class="o">=</span><span class="n">PB</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">coor</span><span class="p">,</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#Check each possible merged Wyckoff position for orientaitons</span>
                    <span class="n">coor</span> <span class="o">=</span> <span class="n">merged</span>

            <span class="k">else</span><span class="p">:</span><span class="c1">#no way to merge</span>
                <span class="c1">#print(&#39;no way to Merge, FFFFFFFFFFFFFFFFFFFFFFF----------------&#39;)</span>
                <span class="k">return</span> <span class="n">coor</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">check_wyckoff_position_molecular</span><span class="p">(</span><span class="n">coor</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">exact_translation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="n">PBC</span><span class="p">,</span> <span class="n">PB</span><span class="o">=</span><span class="n">PB</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">coor</span><span class="p">,</span> <span class="n">index</span></div>

<div class="viewcode-block" id="choose_wyckoff_molecular"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.choose_wyckoff_molecular">[docs]</a><span class="k">def</span> <span class="nf">choose_wyckoff_molecular</span><span class="p">(</span><span class="n">wyckoffs</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">orientations</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Choose a Wyckoff position to fill based on the current number of molecules</span>
<span class="sd">    needed to be placed within a unit cell</span>

<span class="sd">    Rules:</span>

<span class="sd">        1) The new position&#39;s multiplicity is equal/less than (number).</span>
<span class="sd">        2) We prefer positions with large multiplicity.</span>
<span class="sd">        3) The site must admit valid orientations for the desired molecule.</span>

<span class="sd">    Args:</span>
<span class="sd">        wyckoffs: an unsorted list of Wyckoff positions</span>
<span class="sd">        number: the number of molecules still needed in the unit cell</span>
<span class="sd">        orientations: the valid orientations for a given molecule. Obtained</span>
<span class="sd">            from get_sg_orientations, which is called within molecular_crystal</span>

<span class="sd">    Returns:</span>
<span class="sd">        a single index for the Wyckoff position. If no position is found,</span>
<span class="sd">        returns False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">:</span> <span class="c1">#choose from high to low</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">wyckoff</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wyckoffs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wyckoff</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">number</span><span class="p">:</span>
                <span class="n">good_wyckoff</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wyckoff</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">orientations</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="n">good_wyckoff</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_wyckoff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">good_wyckoff</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">orientations</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="p">[]:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot; X&quot;</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">choose</span><span class="p">(</span><span class="n">good_wyckoff</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">good_wyckoff</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">wyckoff</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wyckoffs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wyckoff</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">number</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wyckoff</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">orientations</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="n">good_wyckoff</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_wyckoff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">good_wyckoff</span><span class="p">:</span>
                <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">indices</span>
                <span class="k">if</span> <span class="n">orientations</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot; Y&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">choose</span><span class="p">(</span><span class="n">good_wyckoff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="mol_site"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.mol_site">[docs]</a><span class="k">class</span> <span class="nc">mol_site</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for storing molecular Wyckoff positions and orientations within</span>
<span class="sd">    the molecular_crystal class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">wp_index</span><span class="p">,</span> <span class="n">lattice</span><span class="p">):</span>
        <span class="c1">#Pymatgen molecule object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span>
        <span class="c1">#Relative coordinates within the unit cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span>
        <span class="c1">#Spacegroup number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg</span>
        <span class="c1">#single index of the Wyckoff position within the spacegroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wp_index</span> <span class="o">=</span> <span class="n">wp_index</span>
        <span class="c1">#letter of the Wyckoff position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_wyckoffs</span><span class="p">(</span><span class="n">sg</span><span class="p">)[</span><span class="n">wp_index</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">letter</span> <span class="o">=</span> <span class="n">letter_from_index</span><span class="p">(</span><span class="n">wp_index</span><span class="p">,</span> <span class="n">sg</span><span class="p">)</span></div>

<div class="viewcode-block" id="molecular_crystal"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.molecular_crystal">[docs]</a><span class="k">class</span> <span class="nc">molecular_crystal</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for storing and generating molecular crystals based on symmetry</span>
<span class="sd">    constraints. Based on the crystal.random_crystal class for atomic crystals.</span>
<span class="sd">    Given a spacegroup, list of molecule objects, molecular stoichiometry, and</span>
<span class="sd">    a volume factor, generates a molecular crystal consistent with the given</span>
<span class="sd">    constraints. This crystal is stored as a pymatgen struct via self.struct</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        sg: The international spacegroup number</span>
<span class="sd">        molecules: a list of pymatgen.core.structure.Molecule objects for</span>
<span class="sd">            each type of molecule</span>
<span class="sd">        numMols: A list of the number of each type of molecule within the</span>
<span class="sd">            primitive cell (NOT the conventioal cell)</span>
<span class="sd">        volume_factor: A volume factor used to generate a larger or smaller</span>
<span class="sd">            unit cell. Increasing this gives extra space between molecules</span>
<span class="sd">        allow_inversion: Whether or not to allow chiral molecules to be</span>
<span class="sd">            inverted. If True, the final crystal may contain mirror images of</span>
<span class="sd">            the original molecule. Unless the chemical properties of the mirror</span>
<span class="sd">            image are known, it is highly recommended to keep this value False</span>
<span class="sd">        orientations: Once a crystal with the same spacegroup and molecular</span>
<span class="sd">            stoichiometry has been generated, you may pass its</span>
<span class="sd">            valid_orientations attribute here to avoid repeating the</span>
<span class="sd">            calculation, but this is not required</span>
<span class="sd">        check_atomic_distances: If True, checks the inter-atomic distances</span>
<span class="sd">            after each Wyckoff position is added. This requires slightly more</span>
<span class="sd">            time, but vastly improves accuracy. For approximately spherical</span>
<span class="sd">            molecules, or for large inter-molecular distances, this may be</span>
<span class="sd">            turned off</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">molecules</span><span class="p">,</span> <span class="n">numMols</span><span class="p">,</span> <span class="n">volume_factor</span><span class="p">,</span> <span class="n">allow_inversion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orientations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_atomic_distances</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="c1">#Necessary input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msgs</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;A list of warning messages to use during generation.&quot;&quot;&quot;</span>
        <span class="n">numMols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">numMols</span><span class="p">)</span> <span class="c1">#must convert it to np.array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="n">volume_factor</span>
        <span class="sd">&quot;&quot;&quot;The supplied volume factor for the unit cell.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numMols0</span> <span class="o">=</span> <span class="n">numMols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg</span>
        <span class="sd">&quot;&quot;&quot;The international spacegroup number of the crystal.&quot;&quot;&quot;</span>
        <span class="c1">#Reorient the molecules along their principle axes</span>
        <span class="n">oriented_molecules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#Allow support for generating molecules from text via ASE</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">molecules</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">mo</span> <span class="o">=</span> <span class="n">get_ase_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                <span class="n">molecules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mo</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">:</span>
            <span class="n">pga</span> <span class="o">=</span> <span class="n">PointGroupAnalyzer</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">pga</span><span class="o">.</span><span class="n">symmetrize_molecule</span><span class="p">()[</span><span class="s1">&#39;sym_mol&#39;</span><span class="p">]</span>
            <span class="n">oriented_molecules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">oriented_molecules</span>
        <span class="sd">&quot;&quot;&quot;A list of pymatgen.core.structure.Molecule objects, symmetrized and</span>
<span class="sd">        oriented along their symmetry axes.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;A list of bounding boxes for each molecule. Used for estimating</span>
<span class="sd">        volume of the unit cell.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;A list of approximated radii for each molecule type. Used for</span>
<span class="sd">        checking inter-molecular distances.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_box</span><span class="p">(</span><span class="n">reoriented_molecule</span><span class="p">(</span><span class="n">mol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">max_r</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">mol</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">site</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">site</span><span class="o">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">site</span><span class="o">.</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;</span> <span class="n">max_r</span><span class="p">:</span> <span class="n">max_r</span> <span class="o">=</span> <span class="n">radius</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_r</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numMols</span> <span class="o">=</span> <span class="n">numMols</span> <span class="o">*</span> <span class="n">cellsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The number of each type of molecule in the CONVENTIONAL cell&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">estimate_volume_molecular</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numMols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The volume of the generated unit cell&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span> <span class="o">=</span> <span class="n">get_wyckoffs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">organized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The Wyckoff positions for the crystal&#39;s spacegroup. Sorted by</span>
<span class="sd">        multiplicity.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="o">=</span> <span class="n">check_atomic_distances</span>
        <span class="sd">&quot;&quot;&quot;Whether or not inter-atomic distances are checked at each step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_inversion</span> <span class="o">=</span> <span class="n">allow_inversion</span>
        <span class="sd">&quot;&quot;&quot;Whether or not to allow chiral molecules to be inverted.&quot;&quot;&quot;</span>
        <span class="c1">#When generating multiple crystals of the same stoichiometry and sg,</span>
        <span class="c1">#allow the user to re-use the allowed orientations, to reduce time cost</span>
        <span class="k">if</span> <span class="n">orientations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_orientations</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span> <span class="o">=</span> <span class="n">orientations</span>
            <span class="sd">&quot;&quot;&quot;The valid orientations for each molecule and Wyckoff position.</span>
<span class="sd">            May be copied when generating a new molecular_crystal to save a</span>
<span class="sd">            small amount of time&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_crystal</span><span class="p">()</span>


<div class="viewcode-block" id="molecular_crystal.Msgs"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.molecular_crystal.Msgs">[docs]</a>    <span class="k">def</span> <span class="nf">Msgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg1</span> <span class="o">=</span> <span class="s1">&#39;Error: the stoichiometry is incompatible with the wyckoff sites choice&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg2</span> <span class="o">=</span> <span class="s1">&#39;Error: failed in the cycle of generating structures&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg3</span> <span class="o">=</span> <span class="s1">&#39;Warning: failed in the cycle of adding species&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg4</span> <span class="o">=</span> <span class="s1">&#39;Warning: failed in the cycle of choosing wyckoff sites&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg5</span> <span class="o">=</span> <span class="s1">&#39;Finishing: added the specie&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg6</span> <span class="o">=</span> <span class="s1">&#39;Finishing: added the whole structure&#39;</span></div>

<div class="viewcode-block" id="molecular_crystal.get_orientations"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.molecular_crystal.get_orientations">[docs]</a>    <span class="k">def</span> <span class="nf">get_orientations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the valid orientations for each Molecule and Wyckoff</span>
<span class="sd">        position. Returns a list with 4 indices:</span>

<span class="sd">        index 1: the molecular prototype&#39;s index within self.molecules</span>

<span class="sd">        index 2: the Wyckoff position&#39;s 1st index (based on multiplicity)</span>

<span class="sd">        index 3: the WP&#39;s 2nd index (within the group of equal multiplicity)</span>

<span class="sd">        index 4: the index of the valid orientation for the molecule/WP pair</span>

<span class="sd">        For example, self.valid_orientations[i][j][k] would be a list of valid</span>
<span class="sd">        orientations for self.molecules[i], in the Wyckoff position</span>
<span class="sd">        self.wyckoffs[j][k]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">wp_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">wp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="n">wp_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">allowed</span> <span class="o">=</span> <span class="n">orientation_in_wyckoff_position</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">wp_index</span><span class="p">,</span> <span class="n">already_oriented</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_inversion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_inversion</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">allowed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span></div>

<div class="viewcode-block" id="molecular_crystal.check_compatible"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.molecular_crystal.check_compatible">[docs]</a>    <span class="k">def</span> <span class="nf">check_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the number of molecules is compatible with the Wyckoff</span>
<span class="sd">        positions. Considers the number of degrees of freedom for each Wyckoff</span>
<span class="sd">        position, and makes sure at least one valid combination of WP&#39;s exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N_site</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">]</span>
        <span class="n">has_freedom</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#remove WP&#39;s with no freedom once they are filled</span>
        <span class="n">removed_wyckoffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">numMol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numMols</span><span class="p">):</span>
            <span class="c1">#Check that the number of molecules is a multiple of the smallest Wyckoff position</span>
            <span class="k">if</span> <span class="n">numMol</span> <span class="o">%</span> <span class="n">N_site</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Check if smallest WP has at least one degree of freedom</span>
                <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="n">has_freedom</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#Subtract from the number of ions beginning with the smallest Wyckoff positions</span>
                    <span class="n">remaining</span> <span class="o">=</span> <span class="n">numMol</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">wp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                            <span class="k">while</span> <span class="n">remaining</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">wp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">removed_wyckoffs</span><span class="p">:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                                    <span class="c1">#Check if WP has at least one degree of freedom</span>
                                    <span class="n">op</span> <span class="o">=</span> <span class="n">wp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])):</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">degrees</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                                            <span class="c1">#NOTE: degrees of freedom may be inaccurate for linear molecules</span>
                                            <span class="n">has_freedom</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">removed_wyckoffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">has_freedom</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">removed_wyckoffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">remaining</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">has_freedom</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#print(&quot;Warning: Wyckoff Positions have no degrees of freedom.&quot;)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="molecular_crystal.generate_crystal"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.molecular_crystal.generate_crystal">[docs]</a>    <span class="k">def</span> <span class="nf">generate_crystal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max1</span><span class="o">=</span><span class="n">max1</span><span class="p">,</span> <span class="n">max2</span><span class="o">=</span><span class="n">max2</span><span class="p">,</span> <span class="n">max3</span><span class="o">=</span><span class="n">max3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main code to generate a random molecular crystal. If successful,</span>
<span class="sd">        stores a pymatgen.core.structure object in self.struct and sets</span>
<span class="sd">        self.valid to True. If unsuccessful, sets self.valid to False and</span>
<span class="sd">        outputs an error message.</span>

<span class="sd">        Args:</span>
<span class="sd">            max1: the number of attempts for generating a lattice</span>
<span class="sd">            max2: the number of attempts for a given lattice</span>
<span class="sd">            max3: the number of attempts for a given Wyckoff position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Check the minimum number of degrees of freedom within the Wyckoff positions</span>
        <span class="n">degrees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compatible</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">degrees</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Msg1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">struct</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">degrees</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max1</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">max2</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">max3</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="c1">#Calculate a minimum vector length for generating a lattice</span>
            <span class="n">minvector</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="o">*</span><span class="mi">2</span> <span class="k">for</span> <span class="n">radius</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span>
            <span class="c1">#print(self.radii, minvector)</span>
            <span class="k">for</span> <span class="n">cycle1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max1</span><span class="p">):</span>
                <span class="c1">#1, Generate a lattice</span>
                <span class="n">cell_para</span> <span class="o">=</span> <span class="n">generate_lattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="n">minvec</span><span class="o">=</span><span class="n">minvector</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cell_para</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cell_matrix</span> <span class="o">=</span> <span class="n">para2matrix</span><span class="p">(</span><span class="n">cell_para</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">cell_matrix</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error, volume is not equal to the estimated value: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="s1">&#39; -&gt; &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">cell_matrix</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cell_para:  &#39;</span><span class="p">,</span> <span class="n">cell_para</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                    <span class="n">molecular_coordinates_total</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#to store the added molecular coordinates</span>
                    <span class="n">molecular_sites_total</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1">#to store the corresponding molecular specie</span>
                    <span class="n">atomic_coordinates_total</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#to store the added atomic coordinates</span>
                    <span class="n">atomic_sites_total</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1">#to store the corresponding atomic specie</span>
                    <span class="n">wps_total</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1">#to store corresponding Wyckoff position indices</span>
                    <span class="n">points_total</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1">#to store the generating x,y,z points</span>
                    <span class="n">mol_generators_total</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">good_structure</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">for</span> <span class="n">cycle2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max2</span><span class="p">):</span>
                        <span class="n">molecular_coordinates_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_coordinates_total</span><span class="p">)</span>
                        <span class="n">molecular_sites_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_sites_total</span><span class="p">)</span>
                        <span class="n">atomic_coordinates_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_coordinates_total</span><span class="p">)</span>
                        <span class="n">atomic_sites_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_sites_total</span><span class="p">)</span>
                        <span class="n">wps_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">wps_total</span><span class="p">)</span>
                        <span class="n">points_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">points_total</span><span class="p">)</span>
                        <span class="n">mol_generators_tmp</span> <span class="o">=</span> <span class="p">[]</span>
                        
                	    <span class="c1">#Add molecules specie by specie</span>
                        <span class="k">for</span> <span class="n">numMol</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numMols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">):</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                            <span class="n">numMol_added</span> <span class="o">=</span> <span class="mi">0</span>

                            <span class="c1">#Now we start to add the specie to the wyckoff position</span>
                            <span class="k">for</span> <span class="n">cycle3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max3</span><span class="p">):</span>
                                <span class="c1">#Choose a random Wyckoff position for given multiplicity: 2a, 2b, 2c</span>
                                <span class="c1">#NOTE: The molecular version return wyckoff indices, not ops</span>
                                <span class="n">indices</span> <span class="o">=</span> <span class="n">choose_wyckoff_molecular</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">,</span> <span class="n">numMol</span><span class="o">-</span><span class="n">numMol_added</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                                    <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">indices</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Failed to catch empty set...&quot;</span><span class="p">)</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                	    	    <span class="c1">#Generate a list of coords from ops</span>
                                    <span class="n">ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                    <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                                    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">op</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">])</span>
                                    <span class="c1">#merge_coordinate if the atoms are close</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                        <span class="n">mtol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
                                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                        <span class="n">mtol</span> <span class="o">=</span> <span class="mf">3.0</span>
                                    <span class="n">coords_toadd</span><span class="p">,</span> <span class="n">good_merge</span> <span class="o">=</span> <span class="n">merge_coordinate_molecular</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">mtol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="n">good_merge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                                        <span class="n">wp_index</span> <span class="o">=</span> <span class="n">good_merge</span>
                                        <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">jk_from_i</span><span class="p">(</span><span class="n">wp_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">)</span>
                                        <span class="n">wyckoffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                        <span class="n">coords_toadd</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">)</span> <span class="c1">#scale the coordinates to [0,1], very important!</span>

                                        <span class="c1">#Check that coords_toadd are generated by point</span>
                                        <span class="n">generators</span> <span class="o">=</span> <span class="n">get_wyckoff_generators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">)[</span><span class="n">wp_index</span><span class="p">]</span>
                                        <span class="n">point</span> <span class="o">=</span> <span class="n">find_generating_point</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">,</span> <span class="n">generators</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Could not generate merged coordinates from Wyckoff generators&quot;</span><span class="p">)</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                                            <span class="k">return</span>

                                        <span class="c1">#Check inter-molecular distances</span>
                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">check_distance_molecular</span><span class="p">(</span><span class="n">molecular_coordinates_tmp</span><span class="p">,</span> <span class="n">coords_toadd</span><span class="p">,</span> <span class="n">molecular_sites_tmp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
                                                <span class="n">molecular_coordinates_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">)</span>
                                                <span class="n">molecular_sites_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                                <span class="n">wps_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wp_index</span><span class="p">)</span>
                                                <span class="n">points_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                                                <span class="n">numMol_added</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">)</span>
                                                <span class="k">if</span> <span class="n">numMol_added</span> <span class="o">==</span> <span class="n">numMol</span><span class="p">:</span>
                                                    <span class="n">molecular_coordinates_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_coordinates_tmp</span><span class="p">)</span>
                                                    <span class="n">molecular_sites_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_sites_tmp</span><span class="p">)</span>
                                                    <span class="n">wps_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">wps_tmp</span><span class="p">)</span>
                                                    <span class="n">points_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">points_tmp</span><span class="p">)</span>
                                                    <span class="k">break</span>

                                        <span class="c1">#Check inter-atomic distances</span>
                                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                            <span class="c1">#Generate atomic coordinates from molecules</span>
                                            <span class="n">mo</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                            <span class="c1">#get j, k from wp_index</span>
                                            <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
                                            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                                            <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">jk_from_i</span><span class="p">(</span><span class="n">wp_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">)</span>
                                            <span class="n">op1</span> <span class="o">=</span> <span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">get_op</span><span class="p">()</span>
                                            <span class="n">mo</span><span class="o">.</span><span class="n">apply_operation</span><span class="p">(</span><span class="n">op1</span><span class="p">)</span>
                                            <span class="n">ms0</span> <span class="o">=</span> <span class="n">mol_site</span><span class="p">(</span><span class="n">mo</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">wp_index</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">)</span>
                                            <span class="n">wp_atomic_sites</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#The species for the Wyckoff position</span>
                                            <span class="n">wp_atomic_coords</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#The coords for the Wyckoff position</span>
                                            <span class="n">flag1</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">for</span> <span class="n">point_index</span><span class="p">,</span> <span class="n">op2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">get_wyckoff_generators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">)[</span><span class="n">wp_index</span><span class="p">]):</span>
                                                <span class="n">current_atomic_sites</span> <span class="o">=</span> <span class="p">[]</span>
                                                <span class="n">current_atomic_coords</span> <span class="o">=</span> <span class="p">[]</span>
                                                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">mo</span><span class="p">:</span>
                                                    <span class="c1">#Place molecular coordinates in relative coordinates</span>
                                                    <span class="c1">#relative_coords = np.dot(np.linalg.inv(np.transpose(cell_matrix)), site.coords)</span>
                                                    <span class="c1">#relative_coords = np.dot(np.linalg.inv(cell_matrix), site.coords)</span>
                                                    <span class="n">relative_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cell_matrix</span><span class="p">))</span>
                                                    <span class="n">center1</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                                                    <span class="n">rot</span> <span class="o">=</span> <span class="n">SymmOp</span><span class="o">.</span><span class="n">from_rotation_and_translation</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                                                    <span class="n">relative_coords</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">relative_coords</span><span class="p">)</span>
                                                    <span class="n">new_vector</span> <span class="o">=</span> <span class="n">center1</span> <span class="o">+</span> <span class="n">relative_coords</span>
                                                    <span class="n">new_vector</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">new_vector</span><span class="p">)</span>
                                                    <span class="n">current_atomic_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                                    <span class="n">current_atomic_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_vector</span><span class="p">)</span>
                                                <span class="n">wp_atomic_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_atomic_sites</span><span class="p">)</span>
                                                <span class="n">wp_atomic_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_atomic_coords</span><span class="p">)</span>
                                                <span class="c1">#Check distances between molecules in current WP</span>
                                                <span class="k">if</span> <span class="n">point_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                                    <span class="k">for</span> <span class="n">a_index</span><span class="p">,</span> <span class="n">specie2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_atomic_sites</span><span class="p">):</span>
                                                        <span class="n">flag1</span> <span class="o">=</span> <span class="n">check_distance</span><span class="p">([</span><span class="n">wp_atomic_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">current_atomic_coords</span><span class="p">[</span><span class="n">a_index</span><span class="p">]],</span> <span class="n">wp_atomic_sites</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">specie2</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">,</span> <span class="n">d_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                                                        <span class="k">if</span> <span class="n">flag1</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                                            <span class="k">break</span>
                                                    <span class="k">if</span> <span class="n">flag1</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                                        <span class="k">break</span>
                                            <span class="k">if</span> <span class="n">flag1</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                                <span class="c1">#Check distances between current and previous molecular atoms</span>
                                                <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
                                                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">wp_atomic_coords</span><span class="p">:</span>
                                                    <span class="n">a</span> <span class="o">+=</span> <span class="n">x</span>
                                                <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
                                                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">wp_atomic_sites</span><span class="p">:</span>
                                                    <span class="n">b</span> <span class="o">+=</span> <span class="n">x</span>
                                                <span class="n">flag2</span> <span class="o">=</span> <span class="kc">True</span>
                                                <span class="k">for</span> <span class="n">a_index</span><span class="p">,</span> <span class="n">specie2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
                                                    <span class="n">flag2</span> <span class="o">=</span> <span class="n">check_distance</span><span class="p">([</span><span class="n">atomic_coordinates_total</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">a_index</span><span class="p">]],</span> <span class="n">atomic_sites_total</span><span class="p">,</span> <span class="n">specie2</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">,</span> <span class="n">d_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="n">flag2</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="k">break</span>
                                                <span class="k">if</span> <span class="n">flag2</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                                    <span class="n">mol_generators_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ms0</span><span class="p">)</span>
                                                    <span class="n">molecular_coordinates_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">)</span>
                                                    <span class="n">molecular_sites_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                                    <span class="n">atomic_coordinates_tmp</span> <span class="o">+=</span> <span class="n">a</span>
                                                    <span class="n">atomic_sites_tmp</span> <span class="o">+=</span> <span class="n">b</span>
                                                    <span class="n">wps_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wp_index</span><span class="p">)</span>
                                                    <span class="n">points_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                                                    <span class="n">numMol_added</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="n">numMol_added</span> <span class="o">==</span> <span class="n">numMol</span><span class="p">:</span>
                                                        <span class="n">mol_generators_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mol_generators_tmp</span><span class="p">)</span>
                                                        <span class="n">molecular_coordinates_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_coordinates_tmp</span><span class="p">)</span>
                                                        <span class="n">atomic_sites_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_sites_tmp</span><span class="p">)</span>
                                                        <span class="n">atomic_coordinates_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_coordinates_tmp</span><span class="p">)</span>
                                                        <span class="n">molecular_sites_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_sites_tmp</span><span class="p">)</span>
                                                        <span class="n">wps_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">wps_tmp</span><span class="p">)</span>
                                                        <span class="n">points_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">points_tmp</span><span class="p">)</span>
                                                        <span class="k">break</span>

                            <span class="k">if</span> <span class="n">numMol_added</span> <span class="o">!=</span> <span class="n">numMol</span><span class="p">:</span>
                                <span class="k">break</span>  <span class="c1">#need to repeat from the 1st species</span>

                        <span class="k">if</span> <span class="n">numMol_added</span> <span class="o">==</span> <span class="n">numMol</span><span class="p">:</span>
                            <span class="c1">#print(self.Msg6)</span>
                            <span class="n">good_structure</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c1">#reset the coordinates and sites</span>
                            <span class="n">molecular_coordinates_total</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">molecular_sites_total</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">wps_total</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1">#placing molecules here</span>
                    <span class="k">if</span> <span class="n">good_structure</span><span class="p">:</span>
                        <span class="n">final_lattice</span> <span class="o">=</span> <span class="n">cell_matrix</span> 
                        <span class="n">final_coor</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">final_site</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">final_number</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mol_generators</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">center0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">wp_index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">points_total</span><span class="p">,</span> <span class="n">molecular_sites_total</span><span class="p">,</span> <span class="n">wps_total</span><span class="p">):</span>
                                <span class="n">mo</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                <span class="c1">#get j, k from wp_index</span>
                                <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">jk_from_i</span><span class="p">(</span><span class="n">wp_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">)</span>
                                <span class="n">op1</span> <span class="o">=</span> <span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">get_op</span><span class="p">()</span>
                                <span class="n">mo</span><span class="o">.</span><span class="n">apply_operation</span><span class="p">(</span><span class="n">op1</span><span class="p">)</span>
                                <span class="n">ms0</span> <span class="o">=</span> <span class="n">mol_site</span><span class="p">(</span><span class="n">mo</span><span class="p">,</span> <span class="n">center0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">wp_index</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">mol_generators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ms0</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">op2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">get_wyckoff_generators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">)[</span><span class="n">wp_index</span><span class="p">]):</span>
                                    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">mo</span><span class="p">:</span>
                                        <span class="c1">#Place molecular coordinates in relative coordinates</span>
                                        <span class="c1">#relative_coords = np.dot(np.linalg.inv(np.transpose(cell_matrix)), site.coords)</span>
                                        <span class="c1">#relative_coords = np.dot(np.linalg.inv(cell_matrix), site.coords)</span>
                                        <span class="n">relative_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cell_matrix</span><span class="p">))</span>
                                        <span class="n">center1</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">center0</span><span class="p">)</span>
                                        <span class="n">rot</span> <span class="o">=</span> <span class="n">SymmOp</span><span class="o">.</span><span class="n">from_rotation_and_translation</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="n">relative_coords</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">relative_coords</span><span class="p">)</span>
                                        <span class="n">new_vector</span> <span class="o">=</span> <span class="n">center1</span> <span class="o">+</span> <span class="n">relative_coords</span>
                                        <span class="n">new_vector</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">new_vector</span><span class="p">)</span>
                                        <span class="n">final_coor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_vector</span><span class="p">)</span>
                                        <span class="n">final_site</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                        <span class="n">final_number</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">final_coor</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_coordinates_total</span><span class="p">)</span>
                            <span class="n">final_site</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_sites_total</span><span class="p">)</span>
                            <span class="n">final_number</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="n">ele</span><span class="p">)</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">atomic_sites_total</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mol_generators</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mol_generators_total</span><span class="p">)</span>
                            <span class="sd">&quot;&quot;&quot;A list of mol_site objects which can be used</span>
<span class="sd">                            for generating the crystal.&quot;&quot;&quot;</span>

                        <span class="n">final_coor</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">final_coor</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verify_distances</span><span class="p">(</span><span class="n">final_coor</span><span class="p">,</span> <span class="n">final_site</span><span class="p">,</span> <span class="n">final_lattice</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span> <span class="o">=</span> <span class="n">final_lattice</span>
                            <span class="sd">&quot;&quot;&quot;A 3x3 matrix representing the lattice of the</span>
<span class="sd">                            unit cell.&quot;&quot;&quot;</span>  
                            <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">final_coor</span><span class="p">)</span>
                            <span class="sd">&quot;&quot;&quot;The fractional coordinates for each molecule</span>
<span class="sd">                            in the final structure&quot;&quot;&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="n">final_site</span>
                            <span class="sd">&quot;&quot;&quot;The indices within self.molecules corresponding</span>
<span class="sd">                            to the type of molecule for each site in</span>
<span class="sd">                            self.coordinates.&quot;&quot;&quot;</span>              
                            <span class="bp">self</span><span class="o">.</span><span class="n">struct</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span><span class="n">final_lattice</span><span class="p">,</span> <span class="n">final_site</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">final_coor</span><span class="p">))</span>
                            <span class="sd">&quot;&quot;&quot;A pymatgen.core.structure.Structure object for</span>
<span class="sd">                            the final generated crystal.&quot;&quot;&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">spg_struct</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_lattice</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">final_coor</span><span class="p">),</span> <span class="n">final_number</span><span class="p">)</span>
                            <span class="sd">&quot;&quot;&quot;A list of information describing the generated</span>
<span class="sd">                            crystal, which may be used by spglib for symmetry</span>
<span class="sd">                            analysis.&quot;&quot;&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="sd">&quot;&quot;&quot;Whether or not a valid crystal was generated.&quot;&quot;&quot;</span>
                            <span class="k">return</span>
                        <span class="c1">#else: print(&quot;Failed final distance check.&quot;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t generate crystal after max attempts.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">degrees</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: Wyckoff positions have no degrees of freedom.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Msg2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Msg2</span></div></div>

<div class="viewcode-block" id="molecular_crystal_2D"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.molecular_crystal_2D">[docs]</a><span class="k">class</span> <span class="nc">molecular_crystal_2D</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A 2d counterpart to molecular_crystal. Given a layer group, list of</span>
<span class="sd">    molecule objects, molecular stoichiometry, and</span>
<span class="sd">    a volume factor, generates a molecular crystal consistent with the given</span>
<span class="sd">    constraints. This crystal is stored as a pymatgen struct via self.struct</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        number: the layer group number between 1 and 80. NOT equal to the</span>
<span class="sd">            international space group number, which is between 1 and 230</span>
<span class="sd">        molecules: a list of pymatgen.core.structure.Molecule objects for</span>
<span class="sd">            each type of molecule</span>
<span class="sd">        numMols: A list of the number of each type of molecule within the</span>
<span class="sd">            primitive cell (NOT the conventioal cell)</span>
<span class="sd">        thickness: the thickness, in Angstroms, of the unit cell in the 3rd</span>
<span class="sd">            dimension (the direction which is not repeated periodically)</span>
<span class="sd">        volume_factor: A volume factor used to generate a larger or smaller</span>
<span class="sd">            unit cell. Increasing this gives extra space between molecules</span>
<span class="sd">        allow_inversion: Whether or not to allow chiral molecules to be</span>
<span class="sd">            inverted. If True, the final crystal may contain mirror images of</span>
<span class="sd">            the original molecule. Unless the chemical properties of the mirror</span>
<span class="sd">            image are known, it is highly recommended to keep this value False</span>
<span class="sd">        orientations: Once a crystal with the same spacegroup and molecular</span>
<span class="sd">            stoichiometry has been generated, you may pass its</span>
<span class="sd">            valid_orientations attribute here to avoid repeating the</span>
<span class="sd">            calculation, but this is not required</span>
<span class="sd">        check_atomic_distances: If True, checks the inter-atomic distances</span>
<span class="sd">            after each Wyckoff position is added. This requires slightly more</span>
<span class="sd">            time, but vastly improves accuracy. For approximately spherical</span>
<span class="sd">            molecules, or for large inter-molecular distances, this may be</span>
<span class="sd">            turned off</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">molecules</span><span class="p">,</span> <span class="n">numMols</span><span class="p">,</span> <span class="n">thickness</span><span class="p">,</span> <span class="n">volume_factor</span><span class="p">,</span> <span class="n">allow_inversion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orientations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_atomic_distances</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="c1">#Necessary input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msgs</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;A list of warning messages to use during generation.&quot;&quot;&quot;</span>
        <span class="n">numMols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">numMols</span><span class="p">)</span> <span class="c1">#must convert it to np.array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="n">volume_factor</span>
        <span class="sd">&quot;&quot;&quot;The supplied volume factor for the unit cell.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numMols0</span> <span class="o">=</span> <span class="n">numMols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lgp</span> <span class="o">=</span> <span class="n">Layergroup</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The number (between 1 and 80) for the crystal&#39;s layer group.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgp</span><span class="o">.</span><span class="n">sgnumber</span>
        <span class="sd">&quot;&quot;&quot;The number (between 1 and 230) for the international spacegroup.&quot;&quot;&quot;</span>
        <span class="c1">#Reorient the molecules along their principle axes</span>
        <span class="n">oriented_molecules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#Allow support for generating molecules from text via ASE</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">molecules</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">mo</span> <span class="o">=</span> <span class="n">get_ase_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                <span class="n">molecules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mo</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">:</span>
            <span class="n">pga</span> <span class="o">=</span> <span class="n">PointGroupAnalyzer</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">pga</span><span class="o">.</span><span class="n">symmetrize_molecule</span><span class="p">()[</span><span class="s1">&#39;sym_mol&#39;</span><span class="p">]</span>
            <span class="n">oriented_molecules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">oriented_molecules</span>
        <span class="sd">&quot;&quot;&quot;A list of pymatgen.core.structure.Molecule objects, symmetrized and</span>
<span class="sd">        oriented along their symmetry axes.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span> <span class="o">=</span> <span class="n">thickness</span>
        <span class="sd">&quot;&quot;&quot;the thickness, in Angstroms, of the unit cell in the 3rd</span>
<span class="sd">        dimension.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PBC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgp</span><span class="o">.</span><span class="n">permutation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
        <span class="sd">&quot;&quot;&quot;The axis (between 1 and 3) which is not periodic.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgp</span><span class="o">.</span><span class="n">permutation</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> 
        <span class="c1">#TODO: add docstring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgp</span><span class="o">.</span><span class="n">permutation</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> 
        <span class="c1">#TODO: add docstring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;A list of bounding boxes for each molecule. Used for estimating</span>
<span class="sd">        volume of the unit cell.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;A list of approximated radii for each molecule type. Used for</span>
<span class="sd">        checking inter-molecular distances.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_box</span><span class="p">(</span><span class="n">reoriented_molecule</span><span class="p">(</span><span class="n">mol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">max_r</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">mol</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">site</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">site</span><span class="o">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">site</span><span class="o">.</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;</span> <span class="n">max_r</span><span class="p">:</span> <span class="n">max_r</span> <span class="o">=</span> <span class="n">radius</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_r</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numMols</span> <span class="o">=</span> <span class="n">numMols</span> <span class="o">*</span> <span class="n">cellsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The number of each type of molecule in the CONVENTIONAL cell&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">estimate_volume_molecular</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numMols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The volume of the generated unit cell&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span> <span class="o">=</span> <span class="n">get_wyckoffs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">organized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">PB</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PB</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The Wyckoff positions for the crystal&#39;s spacegroup. Sorted by</span>
<span class="sd">        multiplicity.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="o">=</span> <span class="n">check_atomic_distances</span>
        <span class="sd">&quot;&quot;&quot;Whether or not inter-atomic distances are checked at each step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_inversion</span> <span class="o">=</span> <span class="n">allow_inversion</span>
        <span class="sd">&quot;&quot;&quot;Whether or not to allow chiral molecules to be inverted.&quot;&quot;&quot;</span>
        <span class="c1">#When generating multiple crystals of the same stoichiometry and sg,</span>
        <span class="c1">#allow the user to re-use the allowed orientations, to reduce time cost</span>
        <span class="k">if</span> <span class="n">orientations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_orientations</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span> <span class="o">=</span> <span class="n">orientations</span>
            <span class="sd">&quot;&quot;&quot;The valid orientations for each molecule and Wyckoff position.</span>
<span class="sd">            May be copied when generating a new molecular_crystal to save a</span>
<span class="sd">            small amount of time&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_crystal</span><span class="p">()</span>


<div class="viewcode-block" id="molecular_crystal_2D.Msgs"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.molecular_crystal_2D.Msgs">[docs]</a>    <span class="k">def</span> <span class="nf">Msgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg1</span> <span class="o">=</span> <span class="s1">&#39;Error: the stoichiometry is incompatible with the wyckoff sites choice&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg2</span> <span class="o">=</span> <span class="s1">&#39;Error: failed in the cycle of generating structures&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg3</span> <span class="o">=</span> <span class="s1">&#39;Warning: failed in the cycle of adding species&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg4</span> <span class="o">=</span> <span class="s1">&#39;Warning: failed in the cycle of choosing wyckoff sites&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg5</span> <span class="o">=</span> <span class="s1">&#39;Finishing: added the specie&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Msg6</span> <span class="o">=</span> <span class="s1">&#39;Finishing: added the whole structure&#39;</span></div>

<div class="viewcode-block" id="molecular_crystal_2D.get_orientations"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.molecular_crystal_2D.get_orientations">[docs]</a>    <span class="k">def</span> <span class="nf">get_orientations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the valid orientations for each Molecule and Wyckoff</span>
<span class="sd">        position. Returns a list with 4 indices:</span>

<span class="sd">        index 1: the molecular prototype&#39;s index within self.molecules</span>

<span class="sd">        index 2: the Wyckoff position&#39;s 1st index (based on multiplicity)</span>

<span class="sd">        index 3: the WP&#39;s 2nd index (within the group of equal multiplicity)</span>

<span class="sd">        index 4: the index of the valid orientation for the molecule/WP pair</span>

<span class="sd">        For example, self.valid_orientations[i][j][k] would be a list of valid</span>
<span class="sd">        orientations for self.molecules[i], in the Wyckoff position</span>
<span class="sd">        self.wyckoffs[j][k]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">wp_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">wp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="n">wp_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">allowed</span> <span class="o">=</span> <span class="n">orientation_in_wyckoff_position</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">wp_index</span><span class="p">,</span> <span class="n">already_oriented</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_inversion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_inversion</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">allowed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span></div>

<div class="viewcode-block" id="molecular_crystal_2D.check_compatible"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.molecular_crystal_2D.check_compatible">[docs]</a>    <span class="k">def</span> <span class="nf">check_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the number of molecules is compatible with the Wyckoff</span>
<span class="sd">        positions. Considers the number of degrees of freedom for each Wyckoff</span>
<span class="sd">        position, and makes sure at least one valid combination of WP&#39;s exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N_site</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">]</span>
        <span class="n">has_freedom</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#remove WP&#39;s with no freedom once they are filled</span>
        <span class="n">removed_wyckoffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">numMol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numMols</span><span class="p">):</span>
            <span class="c1">#Check that the number of molecules is a multiple of the smallest Wyckoff position</span>
            <span class="k">if</span> <span class="n">numMol</span> <span class="o">%</span> <span class="n">N_site</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Check if smallest WP has at least one degree of freedom</span>
                <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="n">has_freedom</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#Subtract from the number of ions beginning with the smallest Wyckoff positions</span>
                    <span class="n">remaining</span> <span class="o">=</span> <span class="n">numMol</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">wp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                            <span class="k">while</span> <span class="n">remaining</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">wp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">removed_wyckoffs</span><span class="p">:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                                    <span class="c1">#Check if WP has at least one degree of freedom</span>
                                    <span class="n">op</span> <span class="o">=</span> <span class="n">wp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])):</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">degrees</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                                            <span class="c1">#NOTE: degrees of freedom may be inaccurate for linear molecules</span>
                                            <span class="n">has_freedom</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">removed_wyckoffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">has_freedom</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">removed_wyckoffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">remaining</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">has_freedom</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#print(&quot;Warning: Wyckoff Positions have no degrees of freedom.&quot;)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="molecular_crystal_2D.generate_crystal"><a class="viewcode-back" href="../../crystallography.molecular_crystal.html#crystallography.molecular_crystal.molecular_crystal_2D.generate_crystal">[docs]</a>    <span class="k">def</span> <span class="nf">generate_crystal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max1</span><span class="o">=</span><span class="n">max1</span><span class="p">,</span> <span class="n">max2</span><span class="o">=</span><span class="n">max2</span><span class="p">,</span> <span class="n">max3</span><span class="o">=</span><span class="n">max3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main code to generate a random molecular crystal. If successful,</span>
<span class="sd">        stores a pymatgen.core.structure object in self.struct and sets</span>
<span class="sd">        self.valid to True. If unsuccessful, sets self.valid to False and</span>
<span class="sd">        outputs an error message.</span>

<span class="sd">        Args:</span>
<span class="sd">            max1: the number of attempts for generating a lattice</span>
<span class="sd">            max2: the number of attempts for a given lattice</span>
<span class="sd">            max3: the number of attempts for a given Wyckoff position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Check the minimum number of degrees of freedom within the Wyckoff positions</span>
        <span class="n">degrees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compatible</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">degrees</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Msg1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">struct</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">degrees</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max1</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">max2</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">max3</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="c1">#Calculate a minimum vector length for generating a lattice</span>
            <span class="n">minvector</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="o">*</span><span class="mi">2</span> <span class="k">for</span> <span class="n">radius</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span>
            <span class="c1">#print(self.radii, minvector)</span>
            <span class="k">for</span> <span class="n">cycle1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max1</span><span class="p">):</span>
                <span class="c1">#1, Generate a lattice</span>
                <span class="n">cell_para</span> <span class="o">=</span> <span class="n">generate_lattice_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">minvec</span><span class="o">=</span><span class="n">minvector</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cell_para</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cell_matrix</span> <span class="o">=</span> <span class="n">para2matrix</span><span class="p">(</span><span class="n">cell_para</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">cell_matrix</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error, volume is not equal to the estimated value: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="s1">&#39; -&gt; &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">cell_matrix</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cell_para:  &#39;</span><span class="p">,</span> <span class="n">cell_para</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                    <span class="n">molecular_coordinates_total</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#to store the added molecular coordinates</span>
                    <span class="n">molecular_sites_total</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1">#to store the corresponding molecular specie</span>
                    <span class="n">atomic_coordinates_total</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#to store the added atomic coordinates</span>
                    <span class="n">atomic_sites_total</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1">#to store the corresponding atomic specie</span>
                    <span class="n">wps_total</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1">#to store corresponding Wyckoff position indices</span>
                    <span class="n">points_total</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1">#to store the generating x,y,z points</span>
                    <span class="n">mol_generators_total</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">good_structure</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">for</span> <span class="n">cycle2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max2</span><span class="p">):</span>
                        <span class="n">molecular_coordinates_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_coordinates_total</span><span class="p">)</span>
                        <span class="n">molecular_sites_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_sites_total</span><span class="p">)</span>
                        <span class="n">atomic_coordinates_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_coordinates_total</span><span class="p">)</span>
                        <span class="n">atomic_sites_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_sites_total</span><span class="p">)</span>
                        <span class="n">wps_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">wps_total</span><span class="p">)</span>
                        <span class="n">points_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">points_total</span><span class="p">)</span>
                        <span class="n">mol_generators_tmp</span> <span class="o">=</span> <span class="p">[]</span>
                        
                	    <span class="c1">#Add molecules specie by specie</span>
                        <span class="k">for</span> <span class="n">numMol</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numMols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">):</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                            <span class="n">numMol_added</span> <span class="o">=</span> <span class="mi">0</span>

                            <span class="c1">#Now we start to add the specie to the wyckoff position</span>
                            <span class="k">for</span> <span class="n">cycle3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max3</span><span class="p">):</span>
                                <span class="c1">#Choose a random Wyckoff position for given multiplicity: 2a, 2b, 2c</span>
                                <span class="c1">#NOTE: The molecular version return wyckoff indices, not ops</span>
                                <span class="n">indices</span> <span class="o">=</span> <span class="n">choose_wyckoff_molecular</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">,</span> <span class="n">numMol</span><span class="o">-</span><span class="n">numMol_added</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                                    <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">indices</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Failed to catch empty set...&quot;</span><span class="p">)</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                	    	    <span class="c1">#Generate a list of coords from ops</span>
                                    <span class="n">ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                    <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                                    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">op</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">])</span>
                                    <span class="c1">#merge_coordinate if the atoms are close</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                        <span class="n">mtol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
                                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                        <span class="n">mtol</span> <span class="o">=</span> <span class="mf">3.0</span>
                                    <span class="n">coords_toadd</span><span class="p">,</span> <span class="n">good_merge</span> <span class="o">=</span> <span class="n">merge_coordinate_molecular</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">mtol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">PBC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="n">PB</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PB</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">good_merge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                                        <span class="n">wp_index</span> <span class="o">=</span> <span class="n">good_merge</span>
                                        <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">jk_from_i</span><span class="p">(</span><span class="n">wp_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">)</span>
                                        <span class="n">wyckoffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                        <span class="c1">#Scale the coordinates to [0,1], except in the no-PBC direction</span>
                                        <span class="n">coords_toadd</span> <span class="o">=</span> <span class="n">filtered_coords</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>

                                        <span class="c1">#Check that coords_toadd are generated by point</span>
                                        <span class="n">generators</span> <span class="o">=</span> <span class="n">get_wyckoff_generators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">)[</span><span class="n">wp_index</span><span class="p">]</span>
                                        <span class="n">point</span> <span class="o">=</span> <span class="n">find_generating_point</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">,</span> <span class="n">generators</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Could not generate merged coordinates from Wyckoff generators&quot;</span><span class="p">)</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                                            <span class="k">return</span>

                                        <span class="c1">#Check inter-molecular distances</span>
                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">check_distance_molecular</span><span class="p">(</span><span class="n">molecular_coordinates_tmp</span><span class="p">,</span> <span class="n">coords_toadd</span><span class="p">,</span> <span class="n">molecular_sites_tmp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PBC</span><span class="p">):</span>
                                                <span class="n">molecular_coordinates_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">)</span>
                                                <span class="n">molecular_sites_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                                <span class="n">wps_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wp_index</span><span class="p">)</span>
                                                <span class="n">points_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                                                <span class="n">numMol_added</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">)</span>
                                                <span class="k">if</span> <span class="n">numMol_added</span> <span class="o">==</span> <span class="n">numMol</span><span class="p">:</span>
                                                    <span class="n">molecular_coordinates_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_coordinates_tmp</span><span class="p">)</span>
                                                    <span class="n">molecular_sites_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_sites_tmp</span><span class="p">)</span>
                                                    <span class="n">wps_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">wps_tmp</span><span class="p">)</span>
                                                    <span class="n">points_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">points_tmp</span><span class="p">)</span>
                                                    <span class="k">break</span>

                                        <span class="c1">#Check inter-atomic distances</span>
                                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                            <span class="c1">#Generate atomic coordinates from molecules</span>
                                            <span class="n">mo</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                            <span class="c1">#get j, k from wp_index</span>
                                            <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
                                            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                                            <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">jk_from_i</span><span class="p">(</span><span class="n">wp_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">)</span>
                                            <span class="n">op1</span> <span class="o">=</span> <span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">get_op</span><span class="p">()</span>
                                            <span class="n">mo</span><span class="o">.</span><span class="n">apply_operation</span><span class="p">(</span><span class="n">op1</span><span class="p">)</span>
                                            <span class="n">ms0</span> <span class="o">=</span> <span class="n">mol_site</span><span class="p">(</span><span class="n">mo</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">wp_index</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">)</span>
                                            <span class="n">wp_atomic_sites</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#The species for the Wyckoff position</span>
                                            <span class="n">wp_atomic_coords</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#The coords for the Wyckoff position</span>
                                            <span class="n">flag1</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">for</span> <span class="n">point_index</span><span class="p">,</span> <span class="n">op2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">get_wyckoff_generators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">)[</span><span class="n">wp_index</span><span class="p">]):</span>
                                                <span class="n">current_atomic_sites</span> <span class="o">=</span> <span class="p">[]</span>
                                                <span class="n">current_atomic_coords</span> <span class="o">=</span> <span class="p">[]</span>
                                                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">mo</span><span class="p">:</span>
                                                    <span class="c1">#Place molecular coordinates in relative coordinates</span>
                                                    <span class="c1">#relative_coords = np.dot(np.linalg.inv(np.transpose(cell_matrix)), site.coords)</span>
                                                    <span class="c1">#relative_coords = np.dot(np.linalg.inv(cell_matrix), site.coords)</span>
                                                    <span class="n">relative_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cell_matrix</span><span class="p">))</span>
                                                    <span class="n">center1</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                                                    <span class="n">rot</span> <span class="o">=</span> <span class="n">SymmOp</span><span class="o">.</span><span class="n">from_rotation_and_translation</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                                                    <span class="n">relative_coords</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">relative_coords</span><span class="p">)</span>
                                                    <span class="n">new_vector</span> <span class="o">=</span> <span class="n">center1</span> <span class="o">+</span> <span class="n">relative_coords</span>
                                                    <span class="n">new_vector</span> <span class="o">=</span> <span class="n">filtered_coords</span><span class="p">(</span><span class="n">new_vector</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
                                                    <span class="n">current_atomic_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                                    <span class="n">current_atomic_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_vector</span><span class="p">)</span>
                                                <span class="n">wp_atomic_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_atomic_sites</span><span class="p">)</span>
                                                <span class="n">wp_atomic_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_atomic_coords</span><span class="p">)</span>
                                                <span class="c1">#Check distances between molecules in current WP</span>
                                                <span class="k">if</span> <span class="n">point_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                                    <span class="k">for</span> <span class="n">a_index</span><span class="p">,</span> <span class="n">specie2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_atomic_sites</span><span class="p">):</span>
                                                        <span class="n">flag1</span> <span class="o">=</span> <span class="n">check_distance</span><span class="p">([</span><span class="n">wp_atomic_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">current_atomic_coords</span><span class="p">[</span><span class="n">a_index</span><span class="p">]],</span> <span class="n">wp_atomic_sites</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">specie2</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">,</span> <span class="n">d_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
                                                        <span class="k">if</span> <span class="n">flag1</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                                            <span class="k">break</span>
                                                    <span class="k">if</span> <span class="n">flag1</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                                        <span class="k">break</span>
                                            <span class="k">if</span> <span class="n">flag1</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                                <span class="c1">#Check distances between current and previous molecular atoms</span>
                                                <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
                                                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">wp_atomic_coords</span><span class="p">:</span>
                                                    <span class="n">a</span> <span class="o">+=</span> <span class="n">x</span>
                                                <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
                                                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">wp_atomic_sites</span><span class="p">:</span>
                                                    <span class="n">b</span> <span class="o">+=</span> <span class="n">x</span>
                                                <span class="n">flag2</span> <span class="o">=</span> <span class="kc">True</span>
                                                <span class="k">for</span> <span class="n">a_index</span><span class="p">,</span> <span class="n">specie2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
                                                    <span class="n">flag2</span> <span class="o">=</span> <span class="n">check_distance</span><span class="p">([</span><span class="n">atomic_coordinates_total</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">a_index</span><span class="p">]],</span> <span class="n">atomic_sites_total</span><span class="p">,</span> <span class="n">specie2</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">,</span> <span class="n">d_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="n">flag2</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="k">break</span>
                                                <span class="k">if</span> <span class="n">flag2</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                                    <span class="n">mol_generators_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ms0</span><span class="p">)</span>
                                                    <span class="n">molecular_coordinates_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">)</span>
                                                    <span class="n">molecular_sites_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                                    <span class="n">atomic_coordinates_tmp</span> <span class="o">+=</span> <span class="n">a</span>
                                                    <span class="n">atomic_sites_tmp</span> <span class="o">+=</span> <span class="n">b</span>
                                                    <span class="n">wps_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wp_index</span><span class="p">)</span>
                                                    <span class="n">points_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                                                    <span class="n">numMol_added</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_toadd</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="n">numMol_added</span> <span class="o">==</span> <span class="n">numMol</span><span class="p">:</span>
                                                        <span class="n">mol_generators_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mol_generators_tmp</span><span class="p">)</span>
                                                        <span class="n">molecular_coordinates_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_coordinates_tmp</span><span class="p">)</span>
                                                        <span class="n">atomic_sites_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_sites_tmp</span><span class="p">)</span>
                                                        <span class="n">atomic_coordinates_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_coordinates_tmp</span><span class="p">)</span>
                                                        <span class="n">molecular_sites_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">molecular_sites_tmp</span><span class="p">)</span>
                                                        <span class="n">wps_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">wps_tmp</span><span class="p">)</span>
                                                        <span class="n">points_total</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">points_tmp</span><span class="p">)</span>
                                                        <span class="k">break</span>

                            <span class="k">if</span> <span class="n">numMol_added</span> <span class="o">!=</span> <span class="n">numMol</span><span class="p">:</span>
                                <span class="k">break</span>  <span class="c1">#need to repeat from the 1st species</span>

                        <span class="k">if</span> <span class="n">numMol_added</span> <span class="o">==</span> <span class="n">numMol</span><span class="p">:</span>
                            <span class="c1">#print(self.Msg6)</span>
                            <span class="n">good_structure</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c1">#reset the coordinates and sites</span>
                            <span class="n">molecular_coordinates_total</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">molecular_sites_total</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">wps_total</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1">#placing molecules here</span>
                    <span class="k">if</span> <span class="n">good_structure</span><span class="p">:</span>
                        <span class="n">final_lattice</span> <span class="o">=</span> <span class="n">cell_matrix</span> 
                        <span class="n">final_coor</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">final_site</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">final_number</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">center0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">wp_index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">points_total</span><span class="p">,</span> <span class="n">molecular_sites_total</span><span class="p">,</span> <span class="n">wps_total</span><span class="p">):</span>
                                <span class="n">mo</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                <span class="c1">#get j, k from wp_index</span>
                                <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">jk_from_i</span><span class="p">(</span><span class="n">wp_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wyckoffs</span><span class="p">)</span>
                                <span class="n">op1</span> <span class="o">=</span> <span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_orientations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">get_op</span><span class="p">()</span>
                                <span class="n">mo</span><span class="o">.</span><span class="n">apply_operation</span><span class="p">(</span><span class="n">op1</span><span class="p">)</span>
                                <span class="n">ms0</span> <span class="o">=</span> <span class="n">mol_site</span><span class="p">(</span><span class="n">mo</span><span class="p">,</span> <span class="n">center0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">wp_index</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">)</span>
                                <span class="n">mol_generators_total</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ms0</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">op2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">get_wyckoff_generators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sg</span><span class="p">)[</span><span class="n">wp_index</span><span class="p">]):</span>
                                    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">mo</span><span class="p">:</span>
                                        <span class="c1">#Place molecular coordinates in relative coordinates</span>
                                        <span class="n">relative_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cell_matrix</span><span class="p">))</span>
                                        <span class="n">center1</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">center0</span><span class="p">)</span>
                                        <span class="n">rot</span> <span class="o">=</span> <span class="n">SymmOp</span><span class="o">.</span><span class="n">from_rotation_and_translation</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="n">relative_coords</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">relative_coords</span><span class="p">)</span>
                                        <span class="n">new_vector</span> <span class="o">=</span> <span class="n">center1</span> <span class="o">+</span> <span class="n">relative_coords</span>
                                        <span class="n">new_vector</span> <span class="o">=</span> <span class="n">filtered_coords</span><span class="p">(</span><span class="n">new_vector</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
                                        <span class="n">final_coor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_vector</span><span class="p">)</span>
                                        <span class="n">final_site</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                        <span class="n">final_number</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mol_generators</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mol_generators_total</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_atomic_distances</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">final_coor</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_coordinates_total</span><span class="p">)</span>
                            <span class="n">final_site</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atomic_sites_total</span><span class="p">)</span>
                            <span class="n">final_number</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="n">ele</span><span class="p">)</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">atomic_sites_total</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mol_generators</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mol_generators_total</span><span class="p">)</span>
                            <span class="sd">&quot;&quot;&quot;A list of mol_site objects which can be used</span>
<span class="sd">                            for generating the crystal.&quot;&quot;&quot;</span>

                        <span class="n">final_coor</span> <span class="o">=</span> <span class="n">filtered_coords</span><span class="p">(</span><span class="n">final_coor</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verify_distances</span><span class="p">(</span><span class="n">final_coor</span><span class="p">,</span> <span class="n">final_site</span><span class="p">,</span> <span class="n">final_lattice</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span> <span class="o">=</span> <span class="n">final_lattice</span>
                            <span class="sd">&quot;&quot;&quot;A 3x3 matrix representing the lattice of the</span>
<span class="sd">                            unit cell.&quot;&quot;&quot;</span>  
                            <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">final_coor</span><span class="p">)</span>
                            <span class="sd">&quot;&quot;&quot;The fractional coordinates for each molecule</span>
<span class="sd">                            in the final structure&quot;&quot;&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="n">final_site</span>
                            <span class="sd">&quot;&quot;&quot;The indices within self.molecules corresponding</span>
<span class="sd">                            to the type of molecule for each site in</span>
<span class="sd">                            self.coordinates.&quot;&quot;&quot;</span>              
                            <span class="bp">self</span><span class="o">.</span><span class="n">struct</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span><span class="n">final_lattice</span><span class="p">,</span> <span class="n">final_site</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">final_coor</span><span class="p">))</span>
                            <span class="sd">&quot;&quot;&quot;A pymatgen.core.structure.Structure object for</span>
<span class="sd">                            the final generated crystal.&quot;&quot;&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">spg_struct</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_lattice</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">final_coor</span><span class="p">),</span> <span class="n">final_number</span><span class="p">)</span>
                            <span class="sd">&quot;&quot;&quot;A list of information describing the generated</span>
<span class="sd">                            crystal, which may be used by spglib for symmetry</span>
<span class="sd">                            analysis.&quot;&quot;&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="sd">&quot;&quot;&quot;Whether or not a valid crystal was generated.&quot;&quot;&quot;</span>
                            <span class="k">return</span>
                        <span class="c1">#else: print(&quot;Failed final distance check.&quot;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t generate crystal after max attempts.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">degrees</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: Wyckoff positions have no degrees of freedom.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Msg2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Msg2</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1">#-------------------------------- Options -------------------------</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">mkdir</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--spacegroup&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;sg&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;sg&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;desired space group number: 1-230, e.g., 36&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="s2">&quot;--molecule&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;molecule&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;H2O&#39;</span><span class="p">,</span> 
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;desired molecules: e.g., H2O&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;molecule&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;--numMols&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;numMols&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;desired numbers of molecules: 4&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;numMols&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--factor&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;factor&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> 
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;volume factor: default 3.0&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;factor&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbosity&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;verbosity&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;verbosity: default 0; higher values print more information&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;verbosity&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;--attempts&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;attempts&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> 
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;number of crystals to generate: default 1&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;attempts&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--outdir&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;outdir&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> 
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory for storing output cif files: default &#39;out&#39;&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;outdir&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--checkatoms&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;checkatoms&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> 
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to check inter-atomic distances at each step: default True&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;outdir&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--allowinversion&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;allowinversion&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;False&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> 
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to allow inversion of chiral molecules: default False&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;outdir&quot;</span><span class="p">)</span>

    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>    
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">molecule</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">numMols</span>
    <span class="n">verbosity</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">verbosity</span>
    <span class="n">attempts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">attempts</span>
    <span class="n">outdir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">outdir</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">checkatoms</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">checkatoms</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span>
        <span class="n">checkatoms</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">checkatoms</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid value for -c (--checkatoms): must be &#39;True&#39; or &#39;False&#39;.&quot;</span><span class="p">)</span>
        <span class="n">checkatoms</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">allowinversion</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">allowinversion</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span>
        <span class="n">allowinversion</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">allowinversion</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid value for -i (--allowinversion): must be &#39;True&#39; or &#39;False&#39;.&quot;</span><span class="p">)</span>
        <span class="n">allowinversion</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">numMols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">molecule</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">strings</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">system</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">:</span>
            <span class="n">system</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_ase_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">number</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">numMols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">system</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_ase_mol</span><span class="p">(</span><span class="n">molecule</span><span class="p">)]</span>
        <span class="n">numMols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)]</span>
    <span class="n">orientations</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">attempts</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">numMols0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">numMols</span><span class="p">)</span>
        <span class="n">sg</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">sg</span>
        <span class="n">rand_crystal</span> <span class="o">=</span> <span class="n">molecular_crystal</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">numMols0</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">factor</span><span class="p">,</span> <span class="n">orientations</span><span class="o">=</span><span class="n">orientations</span><span class="p">,</span> <span class="n">check_atomic_distances</span><span class="o">=</span><span class="n">checkatoms</span><span class="p">,</span> <span class="n">allow_inversion</span><span class="o">=</span><span class="n">allowinversion</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">timespent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rand_crystal</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
            <span class="n">written</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rand_crystal</span><span class="o">.</span><span class="n">struct</span><span class="o">.</span><span class="n">composition</span><span class="p">)</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">cifpath</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">comp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.cif&#39;</span>
                <span class="n">CifWriter</span><span class="p">(</span><span class="n">rand_crystal</span><span class="o">.</span><span class="n">struct</span><span class="p">,</span> <span class="n">symprec</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">cifpath</span><span class="p">)</span>
                <span class="n">written</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

            <span class="c1">#spglib style structure called cell</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">get_symmetry_dataset</span><span class="p">(</span><span class="n">rand_crystal</span><span class="o">.</span><span class="n">spg_struct</span><span class="p">,</span> <span class="n">symprec</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">)[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Space group requested: &#39;</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="s1">&#39;generated&#39;</span><span class="p">,</span> <span class="n">ans</span><span class="p">,</span> <span class="s1">&#39;vol: &#39;</span><span class="p">,</span> <span class="n">rand_crystal</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">written</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Output to &quot;</span><span class="o">+</span><span class="n">cifpath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Could not write cif file.&quot;</span><span class="p">)</span>

            <span class="c1">#Print additional information about the structure</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time required for generation: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timespent</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Molecular Wyckoff positions:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">rand_crystal</span><span class="o">.</span><span class="n">mol_generators</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">composition</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">letter</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">rand_crystal</span><span class="o">.</span><span class="n">struct</span><span class="p">)</span>

        <span class="c1">#If generation fails</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;something is wrong&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time spent during generation attempt: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timespent</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">crystallography 0.1dev documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Scott Fredericks, Qiang Zhu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>